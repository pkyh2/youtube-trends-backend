generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Video {
  title         String
  duration      Int
  type          String
  rank          Int
  aspect_ratio  String
  category_id   String
  channel_title String
  comment_count BigInt
  created_at    DateTime @default(now())
  is_ad         Boolean  @default(false)
  like_count    BigInt
  published_at  DateTime
  region_code   String   @default("KR")
  thumbnail_url String
  updated_at    DateTime @updatedAt
  video_id      String   @id
  view_count    BigInt
  channel_id    String
  first_seen_at DateTime @default(now())
  last_seen_at  DateTime @default(now())
  trending_days Int      @default(1)
  category      Category @relation(fields: [category_id], references: [category_id], onDelete: Cascade)

  @@index([type, category_id, region_code, rank])
  @@index([region_code, type, rank])
  @@index([category_id])
  @@index([updated_at])
  @@index([last_seen_at])
  @@index([trending_days, category_id])
  @@map("videos")
}

model Category {
  name_en     String
  name_ko     String
  category_id String   @id
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  videos      Video[]

  @@map("categories")
}

model Channel {
  channel_id       String       @id
  title            String
  description      String
  thumbnail_url    String
  view_count       BigInt
  subscriber_count BigInt
  video_count      BigInt
  published_at     DateTime
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  transcripts      Transcript[]

  @@map("channels")
}

model Transcript {
  id         String   @id @default(cuid())
  channel_id String
  video_id   String   @unique
  transcript String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  channel    Channel  @relation(fields: [channel_id], references: [channel_id], onDelete: Cascade)

  @@index([channel_id, video_id])
  @@map("transcripts")
}

enum Status {
  DRAFT
  READY
  PROCESSING
  SCENES_DONE
  RENDERED
  PUBLISHED
}

model ShortsStory {
  id                  Int                   @id @default(autoincrement())
  category            String
  title               String
  full_script         String
  target_length_sec   Int?                  @default(45)
  tts_voice_profile   String?               @default("neutral")
  hashtags            String?
  visual_style        Json?                
  status              Status                @default(DRAFT)
  is_processing       Boolean?              @default(false)
  final_video_url     String?
  youtube_video_id    String?

  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?             @default(now()) @db.Timestamptz(6)
  shorts_story_scenes ShortsStoryScene[]

  @@index([status])
  @@index([category, status])
  @@index([is_processing])
  @@index([created_at])
  @@map("shorts_stories")
}

enum SceneStatus {
  READY
  IMG_DONE
  TTS_DONE
  VIDEO_DONE
  SCENE_DONE
}

model ShortsStoryScene {
  id             Int         @id @default(autoincrement())
  shorts_story_id Int
  scene_order    Int
  duration_sec   Int?

  image_prompt   String?
  video_prompt   String?
  
  image_url      String?
  video_url      String?
  tts_audio_url  String?
  merged_video_url String?
  
  status         SceneStatus @default(READY)
  retry_count    Int?        @default(0)
  error_message   String?
  
  created_at     DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?   @default(now()) @db.Timestamptz(6)
  shorts_story   ShortsStory @relation(fields: [shorts_story_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  segments       ShortsStorySceneSegment[]

  @@unique([shorts_story_id, scene_order])
  @@index([shorts_story_id, scene_order])
  @@index([status])
  @@index([shorts_story_id, status])
  @@map("shorts_story_scenes")
}

model ShortsStorySceneSegment {
  id             Int         @id @default(autoincrement())
  scene_id       Int
  segment_order  Int
  speaker_key    String

  text           String
  tts_audio_url  String?
  duration_sec   Int?

  status         SceneStatus @default(READY)
  retry_count    Int?        @default(0)
  error_message   String?

  created_at     DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?   @default(now()) @db.Timestamptz(6)
  scene          ShortsStoryScene @relation(fields: [scene_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  speaker        ShortsStoryVoice @relation(fields: [speaker_key], references: [speaker_key], onDelete: Cascade, onUpdate: NoAction)

  @@index([scene_id])
  @@index([segment_order])
  @@index([status])
  @@index([scene_id, status])
  @@map("shorts_story_scene_segments")
}

model ShortsStoryVoice {
  id             Int         @id @default(autoincrement())
  speaker_key    String      @unique
  tts_provider   String      @default("google")
  voice_name     String
  ssml_gender    String

  created_at     DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?   @default(now()) @db.Timestamptz(6)
  segments       ShortsStorySceneSegment[]

  @@index([speaker_key])
  @@index([tts_provider])
  @@index([voice_name])
  @@map("shorts_story_voices")
}